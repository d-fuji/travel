# グループ招待リンク機能 PRD (Product Requirements Document)

## 概要

旅行計画アプリのグループ機能に招待リンク経由でのメンバー追加機能を追加し、より簡単で確実なグループ参加を可能にする。

## 目的

- メンバー招待プロセスの簡素化
- 招待エラー（メールアドレス間違い等）の削減
- 招待リンクの柔軟な共有方法提供
- セキュリティを保ちながら使いやすい招待システムの実現

## 対象ユーザー

- グループ旅行を企画・管理するユーザー
- 旅行グループに参加したいユーザー
- 技術に不慣れなユーザーも含む幅広い年齢層

## 機能要件

### 1. 招待リンク生成機能

#### 1.1 リンク生成
- **ワンクリック生成**：グループ管理者がボタン一つでリンク生成
- **カスタムメッセージ**：招待時に含めるメッセージの設定

#### 1.2 リンク管理
- **リンク一覧表示**：生成済みリンクの管理画面
- **リンク無効化**：既存リンクの即座な無効化
- **使用状況確認**：リンクの使用履歴表示
- **リンク再生成**：新しいリンクの生成

### 2. 招待リンク共有機能

#### 2.1 共有方法
- **コピー&ペースト**：リンクURLのクリップボードコピー
- **QRコード生成**：リンクのQRコード表示・保存
- **SNS共有**：LINE、Twitter、Instagram等への直接共有
- **メール送信**：招待メールの自動作成・送信

#### 2.2 共有コンテンツ
- **プレビュー情報**：旅行名、期間、参加者数の表示
- **招待メッセージ**：カスタマイズ可能な招待文
- **アプリダウンロードリンク**：未インストールユーザー向け

### 3. 招待リンク参加機能

#### 3.1 リンクアクセス処理
- **リンク有効性確認**：リンクの活性状態チェック
- **グループ情報表示**：参加前のグループ詳細確認
- **参加者一覧**：既存メンバーの確認（プライバシー考慮）
- **参加確認画面**：最終的な参加意思確認

#### 3.2 アカウント処理
- **既存ユーザー**：ログイン後に自動グループ参加
- **新規ユーザー**：アカウント作成と同時にグループ参加
- **ゲストモード**：一時的な参加（後でアカウント作成可能）

#### 3.3 ゲストモード機能
- **一時アカウント生成**：ニックネームのみでの簡易参加
- **機能制限**：読み取り専用・コメント投稿のみ等の制限
- **データ継承**：本登録時にゲスト期間のデータを引き継ぎ
- **セッション管理**：デバイス固有の一時的な認証状態

### 4. セキュリティ・権限管理

#### 4.1 アクセス制御
- **トークンベース認証**：セキュアなランダムトークン生成
- **IPアドレス制限**：特定地域からのアクセス制限（オプション）
- **デバイス制限**：同一デバイスからの重複参加防止
- **スパム対策**：短時間での大量アクセス検知・制限

#### 4.2 権限設定
- **管理者権限**：リンク生成・管理は管理者のみ
- **招待者権限**：一般メンバーの招待権限設定
- **参加者権限**：招待経由参加者の初期権限設定

### 5. ゲストユーザー本登録機能

#### 5.1 本登録促進
- **登録推奨バナー**：アプリ内でのゲストユーザーへの登録案内
- **機能制限通知**：制限された機能利用時の登録案内
- **登録インセンティブ**：本登録完了時の特典・機能解放
- **適切なタイミング**：エンゲージメント高い時点での案内

#### 5.2 本登録フロー
- **簡単登録**：最小限の情報入力（メール・パスワードのみ）
- **データ移行確認**：ゲスト期間のデータ継承の説明・確認
- **アカウント統合**：ゲストデータと本アカウントの統合処理
- **登録完了通知**：他メンバーへの正式参加通知

#### 5.3 データ継承機能
- **継承対象データ**：
  - コメント・メッセージ履歴
  - 旅程への参加記録
  - 個人設定・プリファレンス
  - ウィッシュリスト等の個人データ
- **継承除外データ**：一時的なセッション情報・キャッシュ
- **継承失敗時の対応**：データバックアップ・手動復旧オプション

#### 5.4 登録後の権限昇格
- **フル機能アクセス**：全ての制限解除
- **編集権限付与**：旅程・コンテンツの編集権限
- **招待権限付与**：他メンバーの招待権限（設定による）
- **データエクスポート**：個人データの出力機能

### 6. 通知・ログ機能

#### 6.1 通知システム
- **参加通知**：新メンバー参加時の既存メンバーへの通知
- **管理者通知**：リンク使用・期限切れ等の管理者への通知
- **参加者通知**：参加完了の確認通知

#### 6.2 ログ・履歴
- **使用ログ**：リンク使用日時・IPアドレス・参加者情報
- **参加履歴**：メンバーの参加経路（招待 vs リンク）記録
- **エラーログ**：失敗した招待の記録・分析

## 技術仕様

### データ構造

```typescript
interface InvitationLink {
  id: string;
  groupId: string;
  token: string; // セキュアなランダムトークン
  createdBy: string; // User ID
  customMessage?: string;
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
}

interface InvitationUsage {
  id: string;
  invitationLinkId: string;
  userId: string;
  usedAt: Date;
  success: boolean;
}

interface InvitationSettings {
  id: string;
  groupId: string;
  allowMemberInvite: boolean; // 一般メンバーの招待権限
  requireApproval: boolean; // 管理者承認が必要か
  allowGuestMode: boolean; // ゲストモード許可
}

interface GuestUser {
  id: string;
  tempId: string; // 一時的なID
  nickname: string;
  groupId: string;
  deviceFingerprint: string; // デバイス識別用
  joinedAt: Date;
  lastActiveAt: Date;
  isConverted: boolean; // 本登録済みかどうか
  convertedUserId?: string; // 本登録後のユーザーID
  permissions: GuestPermission[];
}

interface GuestPermission {
  action: string; // 'read', 'comment', 'edit_wishlist' etc.
  allowed: boolean;
  resource?: string; // 対象リソース
}
```

### URL構造

```
招待リンク形式：
https://app.travel.com/invite/{token}

クエリパラメータ（オプション）：
- ref: 共有元の識別（analytics用）
- utm_source: トラッキング用
```

### API設計

```typescript
// 招待リンク関連API

// 招待リンク生成
POST /api/groups/{groupId}/invitation-links
{
  customMessage?: string;
}

// グループの招待リンク一覧取得
GET /api/groups/{groupId}/invitation-links

// 招待リンク詳細取得（参加前確認用）
GET /api/invitation/{token}

// 招待リンク経由参加
POST /api/invitation/{token}/join
{
  userId?: string; // 既存ユーザーの場合
  userData?: UserRegistrationData; // 新規ユーザーの場合
  guestData?: { nickname: string; deviceFingerprint: string }; // ゲストの場合
}

// 招待リンクの無効化
PATCH /api/invitation-links/{linkId}/deactivate

// 招待リンクの削除
DELETE /api/invitation-links/{linkId}

// 招待リンクの使用履歴取得
GET /api/invitation-links/{linkId}/usage

// 招待設定関連API

// 招待設定の取得
GET /api/groups/{groupId}/invitation-settings

// 招待設定の更新
PATCH /api/groups/{groupId}/invitation-settings
{
  allowMemberInvite?: boolean;
  requireApproval?: boolean;
  allowGuestMode?: boolean;
}

// ゲストユーザー本登録（将来実装）
POST /api/guest/{tempId}/convert
{
  email: string;
  password: string;
  name?: string;
}
```

## UI/UX設計

### 管理者側UI
1. **グループ編集画面**：メンバー管理と招待リンク管理をタブ形式で統合
2. **リンク管理タブ**：招待リンク一覧・生成・管理機能
3. **リンク生成モーダル**：カスタムメッセージ入力と簡素な作成フロー
4. **共有オプション**：リンクのコピー機能と管理ボタン

### 参加者側UI
1. **招待ページ**：グループ情報・参加確認
2. **アカウント選択**：ログイン・新規登録・ゲストモード
3. **参加完了画面**：参加成功・次のステップ案内
4. **エラーページ**：期限切れ・無効リンクの案内

### ゲストユーザー向けUI
1. **ゲスト参加画面**：ニックネーム入力・機能制限説明
2. **制限通知バナー**：機能制限時の登録促進バナー
3. **本登録画面**：簡単な登録フォーム・データ継承説明
4. **登録完了画面**：権限昇格・機能解放の案内

### レスポンシブ対応
- **モバイル最適化**：タッチ操作・小画面対応
- **QRコード**：モバイルカメラでの読み取り対応
- **共有機能**：ネイティブ共有APIの活用

#### UI/UX実装要件（開発標準）
- **統一モーダルデザイン**：`fixed inset-0 bg-black bg-opacity-50` の共通スタイル
- **z-index管理**：モーダル重なり順序の適切な管理（z-50, z-60等）
- **セキュリティ表示**：招待リンクの安全性を示すUI要素
- **エラーハンドリング**：期限切れ・無効リンクの分かりやすい表示
- **プログレス表示**：招待・参加プロセスの進捗可視化

## 実装フェーズ

### Phase 1: 基本招待機能
- [x] 招待リンク生成・管理
- [x] 基本的な参加フロー
- [x] セキュリティトークン実装
- [x] グループベースの招待システム
- [x] グループ編集画面への統合
- [x] 招待リンクの無効化・削除機能
- [x] モックデータ対応（開発・テスト用）

### Phase 2: 共有・UX向上
- [ ] QRコード生成
- [ ] SNS共有機能
- [x] カスタムメッセージ（実装済み）
- [x] 参加前プレビュー画面（実装済み）
- [ ] 招待リンク使用履歴の表示機能

### Phase 3: ゲストモード・本登録機能
- [x] ゲストユーザー機能（UI実装済み）
- [ ] 機能制限システム
- [ ] 本登録フロー
- [ ] データ継承機能
- [ ] ゲスト認証システム強化

### Phase 4: セキュリティ・分析強化
- [x] 基本権限設定（実装済み）
- [ ] 使用状況分析・通知システム
- [ ] 高度なセキュリティ機能（IP制限等）
- [ ] 管理者承認機能
- [ ] スパム対策機能

## 成功指標

- 招待リンク使用率：80%以上（従来のメール招待と比較）
- 参加完了率：90%以上（リンクアクセス後の参加率）
- ゲストモード利用率：60%以上（新規ユーザーのゲスト選択率）
- ゲスト→本登録転換率：40%以上（ゲストユーザーの本登録率）
- 招待エラー率：5%以下（無効リンク等）
- ユーザーの招待体験満足度向上

## リスク・考慮事項

### セキュリティリスク
- **トークン推測攻撃**：十分にランダムなトークン生成
- **リンク漏洩**：意図しない第三者による参加
- **スパム攻撃**：大量の偽参加リクエスト

### UXリスク
- **複雑化**：機能追加による招待フローの複雑化
- **エラー処理**：無効リンクでの分かりやすいエラー表示
- **プライバシー**：参加前の情報開示レベル
- **ゲスト体験**：制限機能での不満・離脱リスク
- **データ移行**：本登録時のデータ継承失敗・混乱

### 技術的リスク
- **スケーラビリティ**：大量の同時招待処理
- **データ整合性**：参加タイミングでの競合状態・ゲストデータ移行
- **パフォーマンス**：QRコード生成・画像処理負荷
- **セッション管理**：ゲストユーザーの一時的認証状態管理
- **データ重複**：ゲスト→本登録時の重複データ問題

## 関連ファイル

実装済みファイル：
- `src/types/index.ts` - 招待関連の型定義
- `src/components/EditGroupModal.tsx` - グループ編集画面に招待機能を統合（モック対応含む）
- `src/services/invitationApi.ts` - 招待API処理（完全なAPIセット）
- `src/app/invite/[token]/page.tsx` - 招待リンク参加ページ（ゲストモード対応）
- `src/stores/authStore.ts` - ゲスト認証状態管理
- `src/app/page.tsx` - ホームページからグループ編集へのアクセス

## 開発・テスト機能

### モックデータ対応
- **モック招待リンク生成**: APIエラー時にサンプルデータを表示
- **モック操作**: リンクの作成・無効化・削除のローカルシミュレーション
- **リアルなデータ構造**: 実際のAPIレスポンスと同じデータ形式
- **状態管理**: 有効/無効ステータス、作成日時の管理

### APIエンドポイントカバレッジ
実装済みAPIエンドポイント：
- ✅ 招待リンク作成
- ✅ 招待リンク一覧取得
- ✅ 招待リンク詳細取得
- ✅ 招待経由参加
- ✅ リンク無効化
- ✅ リンク削除
- ✅ 使用履歴取得
- ✅ 招待設定管理
- ⚠️ ゲスト本登録（UIのみ、API未実装）